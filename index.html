<!doctype html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Megacalculator Pro</title>
    <meta name="theme-color" content=" " id="themeColor">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    
    <!-- Theme colors (Adaptive: Light / Dark) -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    
    <!-- iOS PWA Support -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-icon-167.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


    <!-- Libraries (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11/lib/browser/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script>


    <style>
        :root {
            --bg: #07101a;
            --accent-grad: linear-gradient(90deg, #60e3ff, #8a6bff);
            --panel: rgba(255, 255, 255, 0.06);
            --panel-strong: rgba(255, 255, 255, 0.09);
            --text: #eef6ff;
            --muted: rgba(238, 246, 255, 0.75);
            --edge: rgba(255, 255, 255, 0.08);
            --glass-blur: 12px;
            --radius: 18px;
            --shadow: 0 12px 36px rgba(2, 6, 23, 0.5);
            --font-size-base: 16px;
            --spacing-unit: 1rem;
        }

        html[data-theme="light"] {
            --bg: #f2f7fb;
            --panel: rgba(255, 255, 255, 0.85);
            --panel-strong: rgba(255, 255, 255, 0.95);
            --text: #0b1220;
            --muted: rgba(10, 20, 30, 0.75);
            --edge: rgba(10, 20, 30, 0.08);
            --shadow: 0 8px 24px rgba(14, 20, 34, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--font-size-base);
        }

        body {
            color: var(--text);
            background: var(--bg);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease;
            overflow-x: hidden;
            padding-bottom: 5rem; /* Space for mini voice button */
        }

        /* LANDING */
        #landing {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1.5rem;
            background: var(--bg);
        }

        .landing-card {
            width: min(980px, 92vw);
            border-radius: var(--radius);
            padding: 1.5rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--edge);
            backdrop-filter: blur(var(--glass-blur)) saturate(120%);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .logo {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: 0.3px;
            background: var(--accent-grad);
            -webkit-background-clip: text;
            color: transparent;
        }

        .tagline {
            margin-top: 0.5rem;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .intro {
            margin-top: 1rem;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--muted);
            min-height: 3.5rem;
        }

        .continueRow {
            margin-top: 1.25rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid var(--edge);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 44px;
            min-height: 44px;
            transition: transform 0.15s ease, background 0.15s ease;
            touch-action: manipulation;
        }

        .btn:hover {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .btn:active {
            transform: translateY(2px) scale(0.98);
        }

        #landingCanvas {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        /* APP HEADER */
        header.appbar {
            position: sticky;
            top: 0;
            z-index: 9000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            backdrop-filter: blur(10px) saturate(120%);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-bottom: 1px solid var(--edge);
        }

        .appLogo {
            font-weight: 800;
            font-size: 1.2rem;
            background: var(--accent-grad);
            -webkit-background-clip: text;
            color: transparent;
        }

        .tabsRow {
            display: flex;
            gap: 0.5rem;
            margin-left: 0.75rem;
            flex: 1;
            align-items: center;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabsRow::-webkit-scrollbar {
            display: none;
        }

        .tabBtn {
            padding: 0.6rem 1rem;
            border-radius: 999px;
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
            white-space: nowrap;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, transform 0.15s ease;
        }

        .tabBtn:hover {
            background: linear-gradient(90deg, rgba(123, 227, 255, 0.15), rgba(138, 107, 255, 0.1));
        }

        .tabBtn.active {
            background: linear-gradient(90deg, rgba(123, 227, 255, 0.2), rgba(138, 107, 255, 0.15));
            border-color: var(--edge);
            transform: translateY(-1px);
        }

        .rightControls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .themeToggle {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            border: 1px solid var(--edge);
            cursor: pointer;
            background: transparent;
            transition: background 0.15s ease;
        }

        .themeToggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .hamburger {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            border: 1px solid var(--edge);
            cursor: pointer;
            background: transparent;
            transition: background 0.15s ease;
            position: fixed;
            top: 0.5rem;
            right: 1rem;
            z-index: 9600; /* keep above menu */
        }
        
        
        
        .hamburger:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .hamburger .lines {
            width: 24px;
            height: 18px;
            position: relative;
        }

        .hamburger .lines::before,
        .hamburger .lines::after,
        .hamburger .lines div {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--text);
            border-radius: 2px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .hamburger .lines::before {
            top: 0;
        }

        .hamburger .lines div {
            top: 8px;
        }

        .hamburger .lines::after {
            bottom: 0;
        }

        .hamburger.active .lines::before {
            transform: translateY(8px) rotate(45deg);
        }

        .hamburger.active .lines div {
            opacity: 0;
        }

        .hamburger.active .lines::after {
            transform: translateY(-8px) rotate(-45deg);
        }

        @media (min-width: 721px) {
         .hamburger { display: none !important; }
    }

        /* MOBILE MENU */
        .mobileMenu {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 9500;
        overflow: hidden;
    }

    /* Backdrop fade */
    .mobileMenuBackdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }

    /* Sliding panel */
    .mobileMenuPanel {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: min(80vw, 360px);
        background: var(--panel-strong);
        border-right: 1px solid var(--edge);
        padding: 1.25rem;
        backdrop-filter: blur(var(--glass-blur));
        transform: translateX(-100%) scale(0.95);
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
        transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1),
        opacity 0.3s ease-in-out;
        opacity: 0;
    }

    /* Active state */
    .mobileMenu.active .mobileMenuBackdrop {
        opacity: 1;
    }

    .mobileMenu.active .mobileMenuPanel {
        transform: translateX(0) scale(1);
        opacity: 1;
    }

    /* Menu items */
    .menuItem {
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        color: var(--text);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, background 0.25s ease;
    }

    /* Hover with ripple-like effect */
    .menuItem::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
    }

    .menuItem:hover::after {
        width: 200%;
        height: 200%;
        opacity: 1;
    }

    .menuItem:hover {
        transform: translateX(4px);
    }

    /* Little entrance animation for items */
    .mobileMenu.active .menuItem {
        animation: fadeSlideIn 0.4s ease forwards;
    }
    .mobileMenu.active .menuItem:nth-child(1) { animation-delay: 0.05s; }
    .mobileMenu.active .menuItem:nth-child(2) { animation-delay: 0.1s; }
    .mobileMenu.active .menuItem:nth-child(3) { animation-delay: 0.15s; }
    .mobileMenu.active .menuItem:nth-child(4) { animation-delay: 0.2s; }
    .mobileMenu.active .menuItem:nth-child(5) { animation-delay: 0.25s; }
    .mobileMenu.active .menuItem:nth-child(6) { animation-delay: 0.3s; }
    .mobileMenu.active .menuItem:nth-child(7) { animation-delay: 0.35s; }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateX(-15px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

        /* MAIN */
        main.appMain {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0.75rem;
        }

        .gridMain {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 980px) {
            .gridMain {
                grid-template-columns: 1fr 360px;
            }
        }

        .card {
            background: var(--panel);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid var(--edge);
            box-shadow: var(--shadow);
        }

        h2.cardTitle {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .keys {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .key {
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
            font-weight: 700;
            font-size: 1rem;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, transform 0.15s ease;
        }

        .key:hover {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        }

        .key:active {
            transform: scale(0.95);
        }

        .key.op {
            background: linear-gradient(90deg, rgba(95, 214, 255, 0.2), rgba(161, 109, 255, 0.2));
        }

        .historyList {
            max-height: 360px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-right: 0.5rem;
            scrollbar-width: thin;
        }

        .historyList::-webkit-scrollbar {
            width: 6px;
        }

        .historyList::-webkit-scrollbar-thumb {
            background: var(--edge);
            border-radius: 3px;
        }

        .historyItem {
            padding: 0.6rem 0.75rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.12);
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.15s ease;
        }

        .historyItem:hover {
            background: rgba(0, 0, 0, 0.18);
        }

        /* MINI VOICE BUTTON & FLOATING ANSWER */
        .miniBtn {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--edge);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            box-shadow: var(--shadow);
            transition: transform 0.15s ease, background 0.15s ease;
        }

        .miniBtn:hover {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .miniBtn:active {
            transform: scale(0.95);
        }

        .miniToast {
            position: fixed;
            right: 1rem;
            bottom: 5.5rem;
            min-width: 120px;
            max-width: 90vw;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--panel-strong);
            border: 1px solid var(--edge);
            z-index: 9998;
            display: none;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
            font-size: 0.9rem;
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .miniToast {
                left: 1rem;
                right: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }

        /* MATRIX INPUTS */
        .matrixGrid {
            display: grid;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .matrixGrid input {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--edge);
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            background: var(--panel);
            color: var(--text);
        }

        .matrixGrid input:focus {
            outline: none;
            border-color: var(--text);
        }

        .muted {
            color: var(--muted);
        }

        .mono {
            font-family: ui-monospace, Menlo, Consolas, monospace;
        }

        .small {
            font-size: 0.85rem;
        }

        input, select {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--edge);
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--text);
        }

        /* MEDIA QUERIES */
        @media (max-width: 720px) {
            html {
                font-size: 14px; /* Smaller base font for mobile */
            }

            header.appbar {
                padding: 0.5rem 0.75rem;
            }

            .tabsRow {
                display: none;
            }

            .hamburger {
                display: flex;
            }

            .mobileMenu {
                display: block;
            }

            .keys {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.4rem;
            }

            .key {
                padding: 0.8rem;
                font-size: 0.9rem;
                min-height: 48px;
            }

            .card {
                padding: 0.75rem;
            }

            .cardTitle {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .keys {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.3rem;
            }

            .key {
                padding: 0.6rem;
                font-size: 0.85rem;
            }

            .matrixGrid {
                gap: 0.3rem;
            }

            .matrixGrid input {
                padding: 0.4rem;
                font-size: 0.85rem;
            }
        }   

            /* Common style for all dropdowns */
select {
  appearance: none;           /* removes native arrow (cross-browser) */
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: var(--panel-strong);
  border: 1px solid var(--edge);
  border-radius: 0.5rem;
  padding: 0.6rem 2rem 0.6rem 0.8rem; /* space on right for arrow */
  font-size: 0.95rem;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease-in-out;

  /* default DOWN arrow */
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='%23cfd8e3'><path d='M7 10l5 5 5-5'/></svg>");
  background-repeat: no-repeat;
  background-position: right 0.6rem center;
  background-size: 1rem;
}

/* On focus → change to UP arrow */
select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--focus-ring);

  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='%23cfd8e3'><path d='M7 14l5-5 5 5'/></svg>");
}

/* Dropdown box */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: var(--panel-strong);
  border: 1px solid var(--edge);
  border-radius: 0.5rem;
  padding: 0.6rem 2rem 0.6rem 0.8rem;
  font-size: 0.95rem;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease-in-out;

  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='%23cfd8e3'><path d='M7 10l5 5 5-5'/></svg>");
  background-repeat: no-repeat;
  background-position: right 0.6rem center;
  background-size: 1rem;
}

/* On focus → UP arrow */
select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--focus-ring);

  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='%23cfd8e3'><path d='M7 14l5-5 5 5'/></svg>");
}

/* Dropdown menu (works in most browsers) */
select option {
  background-color: var(--panel-strong);
  color: var(--text);
  padding: 0.6rem;
  font-size: 0.95rem;
  border: none;
}

/* Highlighted option */
select option:checked,
select option:hover {
  background-color: var(--accent);
  color: #fff;
}


            
    </style>
</head>

<body>
    <!-- Landing -->
    <section id="landing" aria-hidden="false">
        <canvas id="landingCanvas"></canvas>
        <div class="landing-card landing-content" role="dialog" aria-label="Welcome to Megacalculator Pro">
            <div style="display:flex;align-items:center;gap:1rem">
                <div>
                    <div class="logo">Megacalculator Pro</div>
                    <div class="tagline">Your all-in-one intelligent calculation powerhouse</div>
                </div>
                <div style="margin-left:auto">
                    <button id="skipIntro" class="btn small">Skip</button>
                </div>
            </div>
            <div class="intro" id="introText" aria-live="polite"></div>
            <div class="continueRow">
                <button id="continueBtn" class="btn">Continue</button>
                <div class="muted small" style="margin-left:auto">Fast • Responsive • Voice • OCR • PWA</div>
            </div>
        </div>
    </section>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobileMenu" aria-hidden="true" style="display:none">
        <div class="mobileMenuBackdrop" id="mobileBackdrop"></div>
        <div class="mobileMenuPanel" role="menu">
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
                <div class="appLogo">Megacalculator Pro</div>
                <div  id="closeMobile" style="margin-left:auto"></div>
            </div>
            <div id="mobileMenuItems">
                <div class="menuItem" data-target="calc">Basic Calculator</div>
                <div class="menuItem" data-target="graph">Graph Plotter</div>
                <div class="menuItem" data-target="programmer">Programmer Tools</div>
                <div class="menuItem" data-target="units">Unit Converter</div>
                <div class="menuItem" data-target="matrix">Matrix Lab</div>
                <div class="menuItem" data-target="image">Image → Math</div>
                <div class="menuItem" data-target="exporter">Export & History</div>
            </div>
        </div>
    </div>

    <!-- App header -->
    <header class="appbar" role="banner" aria-hidden="true" id="appHeader" style="display:none">
        <div class="appLogo">Megacalculator Pro</div>
        <div class="tabsRow" id="tabsRow">
            <button class="tabBtn active" data-target="calc">Basic</button>
            <button class="tabBtn" data-target="graph">Graph</button>
            <button class="tabBtn" data-target="programmer">Programmer</button>
            <button class="tabBtn" data-target="units">Units</button>
            <button class="tabBtn" data-target="matrix">Matrix</button>
            <button class="tabBtn" data-target="image">Image→Math</button>
            <button class="tabBtn" data-target="exporter">Export & History</button>
        </div>
        <div class="rightControls">
            <div class="themeToggle" id="themeToggle" title="Toggle theme">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="4"></circle>
                </svg>
            </div>
            <button id="installBtn" class="btn" style="display:none">Install</button>
            <div class="hamburger" id="hamburger" title="Menu">
                <div class="lines">
                    <div></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main application -->
    <main class="appMain" id="appMain" style="display:none" aria-hidden="true">
        <div class="gridMain">
            <div>
                <!-- BASIC -->
                <section id="calc" class="card section active">
                    <h2 class="cardTitle">Basic / Natural-Language Calculator</h2>
                    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
                        <div class="muted small">Type or speak: "two multiplied by five", "square root of 25", "22 minus 48".</div>
                        <div style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
                            <input id="searchHistory" placeholder="Search history" style="padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                            <button id="undoBtn" class="btn small">Undo</button>
                        </div>
                    </div>
                    <div style="margin-top:0.75rem">
                        <input id="calcInput" placeholder="Try: two multiplied by five" style="padding:0.75rem;border-radius:0.75rem;border:1px solid var(--edge);width:100%" />
                    </div>
                    <div class="keys" id="keypad"></div>
                    <div style="margin-top:0.75rem">
                        <div class="muted small">Result:</div>
                        <div id="calcResult" class="mono" style="font-size:1.1rem;margin-top:0.5rem">—</div>
                    </div>
                </section>

                <!-- GRAPH -->
                <section id="graph" class="card section" style="display:none;margin-top:1rem">
                    <h2 class="cardTitle">Graph Plotter</h2>
                    <div class="small muted">Use math.js syntax: <span class="mono">sin(x), x^2, exp(x)</span></div>
                    <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap">
                        <input id="fn" placeholder="sin(x) * x" style="flex:1;padding:0.6rem;border-radius:0.6rem;border:1px solid var(--edge)" />
                        <input id="xmin" type="number" value="-10" style="width:5.5rem;padding:0.6rem;border-radius:0.6rem;border:1px solid var(--edge)" />
                        <input id="xmax" type="number" value="10" style="width:5.5rem;padding:0.6rem;border-radius:0.6rem;border:1px solid var(--edge)" />
                        <button id="plotBtn" class="btn">Plot</button>
                    </div>
                    <div style="height:320px;margin-top:0.75rem">
                        <canvas id="chartCanvas" style="width:100%;height:100%"></canvas>
                    </div>
                </section>

                <!-- PROGRAMMER -->
                <section id="programmer" class="card section" style="display:none;margin-top:1rem">
                    <h2 class="cardTitle">Programmer Tools</h2>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                        <div style="flex:1;min-width:10rem">
                            <label class="small muted">Decimal</label>
                            <input id="dec" value="42" style="width:100%;padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        </div>
                        <div style="flex:1;min-width:10rem">
                            <label class="small muted">Hex</label>
                            <input id="hex" style="width:100%;padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        </div>
                        <div style="flex:1;min-width:10rem">
                            <label class="small muted">Binary</label>
                            <input id="bin" style="width:100%;padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        </div>
                    </div>
                    <div style="display:flex;gap:0.5rem;margin-top:0.6rem;flex-wrap:wrap">
                        <input id="aInt" type="number" value="5" style="width:7rem;padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        <select id="bitOp" style="padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)">
                            <option>&</option>
                            <option>|</option>
                            <option>^</option>
                            <option>&lt;&lt;</option>
                            <option>&gt;&gt;</option>
                            <option>~ (NOT A)</option>
                        </select>
                        <input id="bInt" type="number" value="3" style="width:7rem;padding:0.6rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        <button id="computeBits" class="btn">Compute</button>
                    </div>
                    <pre id="bitOut" class="mono small" style="margin-top:0.6rem">—</pre>
                </section>

                <!-- UNITS -->
                <section id="units" class="card section" style="display:none;margin-top:1rem">
                    <h2 class="cardTitle">Unit Converter</h2>
                
                    <!-- Top row: category + value -->
                    <div class="unitRow">
                        <select id="cat" class="unitSelect">
                            <option value="length">Length</option>
                            <option value="mass">Mass</option>
                            <option value="time">Time</option>
                            <option value="temp">Temperature</option>
                            <option value="volume">Volume</option>
                            <option value="speed">Speed</option>
                            <option value="energy">Energy</option>
                        </select>
                
                        <input id="uVal" type="number" step="any" placeholder="Enter value" class="unitInput" />
                    </div>
                
                    <!-- Second row: from / to -->
                    <div class="unitRow" style="margin-top:0.6rem">
                        <select id="fromUnit" class="unitSelect"></select>
                        <div class="muted small">→</div>
                        <select id="toUnit" class="unitSelect"></select>
                        <button id="doConvert" class="btn">Convert</button>
                    </div>
                
                    <!-- Output -->
                    <div id="uOut" class="mono small" style="margin-top:0.6rem">—</div>
                </section>


                <!-- MATRIX -->
                <section id="matrix" class="card section" style="display:none;margin-top:1rem">
                    <h2 class="cardTitle">Matrix Lab</h2>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
                        <div class="small muted">A size:</div>
                        <input id="rowsA" type="number" min="1" max="8" value="2" style="width:5.5rem;padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        <input id="colsA" type="number" min="1" max="8" value="2" style="width:5.5rem;padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        <div class="small muted" style="margin-left:0.5rem">B size:</div>
                        <input id="rowsB" type="number" min="1" max="8" value="2" style="width:5.5rem;padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                        <input id="colsB" type="number" min="1" max="8" value="2" style="width:5.5rem;padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)" />
                    </div>
                    <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;align-items:center">
                        <select id="mOp" style="padding:0.5rem;border-radius:0.5rem;border:1px solid var(--edge)">
                            <option value="add">A + B</option>
                            <option value="sub">A − B</option>
                            <option value="mul">A × B</option>
                            <option value="div">A · B⁻¹</option>
                            <option value="det">det(A)</option>
                            <option value="inv">inv(A)</option>
                            <option value="transA">transpose(A)</option>
                            <option value="transB">transpose(B)</option>
                        </select>
                        <button id="buildMatrices" class="btn">Build Matrices</button>
                        <button id="doMatrix" class="btn">Compute</button>
                    </div>
                    <div style="display:flex;gap:0.5rem;margin-top:0.6rem;flex-wrap:wrap">
                        <div style="flex:1;min-width:10rem">
                            <div class="muted small">Matrix A</div>
                            <div id="matA" class="matrixGrid"></div>
                        </div>
                        <div style="flex:1;min-width:10rem">
                            <div class="muted small">Matrix B</div>
                            <div id="matB" class="matrixGrid"></div>
                        </div>
                    </div>
                    <pre id="mOut" class="mono small" style="margin-top:0.6rem">—</pre>
                </section>

                <!-- IMAGE -->
            <section id="image" class="card section" style="display:none; margin-top:1rem;">
                <h2 class="cardTitle">📷 Image → Math (OCR)</h2>
                <div class="muted small">
                    Upload a clear image of a math expression to recognize and solve it.
                </div>
            
                <!-- Upload + Status -->
                <div style="margin-top:0.6rem; display:flex; gap:0.8rem; align-items:center; flex-wrap:wrap;">
                    <input id="imgInput" type="file" accept="image/*" style="padding:0.5rem;" />
                    <span id="ocrStatus" class="muted small">—</span>
                </div>
            
                <!-- Results -->
                <div style="margin-top:0.8rem;">
                    <pre id="ocrSteps" class="mono small"
                        style="white-space:pre-wrap; background:#07101a; padding:0.6rem; border-radius:6px; border:1px solid #ddd; max-height:300px; overflow:auto;">
            —
                </pre>
                </div>
            </section>



            <!-- RIGHT COLUMN -->
            <aside>
                <div class="card" style="margin-top: 1rem;">
                    <h2 class="cardTitle">History (last 30)</h2>
                    <div id="historyList" class="historyList"></div>
                </div>
                <div class="card" style="margin-top:1rem;">
                    <h2 class="cardTitle">Export</h2>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                        <button id="exportTxt" class="btn">Export TXT</button>
                        <button id="exportPdf" class="btn">Export PDF</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- MINI VOICE BUTTON -->
    <button class="miniBtn" id="miniBtn" aria-label="Voice Calculator" title="Tap and speak">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="3" width="16" height="18" rx="2" stroke="white" stroke-width="1.2" />
            <circle cx="12" cy="11" r="2" fill="white" />
        </svg>
    </button>
    <div id="miniToast" class="miniToast" role="status" aria-live="polite"></div>

    <script>
        /* ========== STATE & HISTORY ========== */
        const STATE = { history: [], maxHistory: 30, deferredPrompt: null, swUpdateAvailable: false };
        function pushHistory(expr, res) {
            STATE.history.unshift({ expr: String(expr), res: String(res) });
            if (STATE.history.length > STATE.maxHistory) STATE.history.length = STATE.maxHistory;
            renderHistory();
        }
        function undoHistory() {
            if (STATE.history.length) STATE.history.shift();
            renderHistory();
        }
        function renderHistory(filter = '') {
            const list = document.getElementById('historyList'); list.innerHTML = '';
            STATE.history.filter(h => h.expr.toLowerCase().includes(filter.toLowerCase()) || h.res.toLowerCase().includes(filter.toLowerCase()))
                .forEach(h => {
                    const d = document.createElement('div'); d.className = 'historyItem mono'; d.textContent = `${h.expr} = ${h.res}`;
                    d.addEventListener('click', () => { document.getElementById('calcInput').value = h.expr; document.getElementById('calcInput').focus(); }, { passive: true });
                    list.appendChild(d);
                });
        }

        /* ========== LANDING ANIM & INTRO ========== */
        (function landingAnim() {
            const canvas = document.getElementById('landingCanvas'); const ctx = canvas.getContext('2d');
            let w = canvas.width = window.innerWidth, h = canvas.height = window.innerHeight;
            const symbols = ['π', '√', '∑', '∞', '%', '÷', '×', '∫', 'e', 'Σ', 'Δ'];
            const parts = []; for (let i = 0; i < 40; i++) { parts.push({ x: Math.random() * w, y: Math.random() * h, vx: (Math.random() - 0.5) * 0.4, vy: (Math.random() - 0.5) * 0.4, r: 0.5 + Math.random() * 1.5, a: 0.05 + Math.random() * 0.25 }); }
            const floats = []; for (let i = 0; i < 10; i++) { floats.push({ x: Math.random() * w, y: Math.random() * h * 0.6, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.2) * 0.15, sym: symbols[i % symbols.length], size: 16 + Math.random() * 24, ang: Math.random() * Math.PI * 2 }); }
            function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
            window.addEventListener('resize', resize, { passive: true });
            let t = 0;
            function frame() {
                t += 0.005; ctx.clearRect(0, 0, w, h); const g = ctx.createLinearGradient(0, 0, w, h); g.addColorStop(0, 'rgba(96,227,255,0.015)'); g.addColorStop(1, 'rgba(138,107,255,0.01)'); ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);
                parts.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0) p.x += w; if (p.x > w) p.x -= w; if (p.y < 0) p.y += h; if (p.y > h) p.y -= h; ctx.beginPath(); ctx.fillStyle = `rgba(200,230,255,${p.a})`; ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); });
                floats.forEach(f => { f.x += Math.sin(t * 0.7 + f.ang) * 0.15 + f.vx; f.y += Math.cos(t * 0.9 + f.ang) * 0.1 + f.vy; ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(Math.sin(t + f.ang) * 0.12); ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.font = `${f.size}px Inter`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(f.sym, 0, 0); ctx.restore(); });
                requestAnimationFrame(frame);
            }
            frame();
        })();

        const introPhrases = ["Welcome to Megacalculator Pro", "One tool for every calculation — basics, programming, matrices, graphs & OCR", "Speak naturally — I understand square, sqrt, cube, cbrt, multiply, divide."];
        let introIndex = 0; const introEl = document.getElementById('introText');
        function playIntro() { introIndex = 0; introEl.textContent = ''; function showNext() { if (introIndex >= introPhrases.length) return; const s = introPhrases[introIndex++]; let i = 0; introEl.textContent = ''; const iv = setInterval(() => { introEl.textContent += s[i++] || ''; if (i > s.length) { clearInterval(iv); setTimeout(showNext, 600); } }, 28); } showNext(); }
        playIntro();
        document.getElementById('continueBtn').addEventListener('click', enterApp, { passive: true });
        document.getElementById('skipIntro').addEventListener('click', enterApp, { passive: true });
        function enterApp() { const L = document.getElementById('landing'); L.style.transition = 'opacity .3s ease, transform .3s ease'; L.style.opacity = '0'; L.style.transform = 'scale(.98) translateY(-8px)'; setTimeout(() => { L.style.display = 'none'; showApp(); }, 320); }
        function showApp() { document.getElementById('appHeader').style.display = 'flex'; document.getElementById('appHeader').setAttribute('aria-hidden', 'false'); document.getElementById('appMain').style.display = 'block'; document.getElementById('appMain').setAttribute('aria-hidden', 'false'); activateSection('calc'); }

        /* ========== MOBILE MENU ========== */
        const hamburger = document.getElementById('hamburger'), mobileMenu = document.getElementById('mobileMenu'), mobileBackdrop = document.getElementById('mobileBackdrop');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            openMobileMenu();
        }, { passive: true });
        mobileBackdrop.addEventListener('click', () => {
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
            closeMobileMenu();
        }, { passive: true });
        document.getElementById('closeMobile').addEventListener('click', () => {
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
            closeMobileMenu();
        }, { passive: true });
        function openMobileMenu() { mobileMenu.style.display = 'block'; mobileMenu.setAttribute('aria-hidden', 'false'); }
        function closeMobileMenu() { mobileMenu.style.display = 'none'; mobileMenu.setAttribute('aria-hidden', 'true'); }
        
        // Swipe gestures for mobile menu
        let touchStartX = 0, touchEndX = 0;

            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;

                // 👉 Right swipe = open menu
                if (touchEndX - touchStartX > 50 && !mobileMenu.classList.contains('active')) {
                    hamburger.classList.add('active');
                    mobileMenu.classList.add('active');
                    openMobileMenu();
                }

                // 👈 Left swipe = close menu
                if (touchStartX - touchEndX > 50 && mobileMenu.classList.contains('active')) {
                    hamburger.classList.remove('active');
                    mobileMenu.classList.remove('active');
                    closeMobileMenu();
                }
            }, { passive: true });

            document.querySelectorAll('#mobileMenuItems .menuItem').forEach(it =>
                it.addEventListener('click', () => {
                    activateSection(it.dataset.target);
                    hamburger.classList.remove('active');
                    mobileMenu.classList.remove('active');
                    closeMobileMenu();
                }, { passive: true })
            );


        /* ========== TABS ========== */
        document.querySelectorAll('.tabBtn').forEach(btn => btn.addEventListener('click', () => activateSection(btn.dataset.target), { passive: true }));
        function activateSection(id) { 
            document.querySelectorAll('.tabBtn').forEach(b => b.classList.toggle('active', b.dataset.target === id)); 
            document.querySelectorAll('.section').forEach(s => s.style.display = (s.id === id ? 'block' : 'none')); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }

        /* ========== THEME ========== */
        const themeToggle = document.getElementById('themeToggle');
        (function initTheme() { 
            const saved = localStorage.getItem('mcp_theme'); 
            if (saved) document.documentElement.setAttribute('data-theme', saved); 
            document.getElementById('themeColor').setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--bg')); 
        })();
        themeToggle.addEventListener('click', () => { 
            const cur = document.documentElement.getAttribute('data-theme') || 'dark'; 
            const next = cur === 'dark' ? 'light' : 'dark'; 
            document.documentElement.setAttribute('data-theme', next); 
            localStorage.setItem('mcp_theme', next); 
            document.getElementById('themeColor').setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--bg')); 
        });

        /* ========== KEYPAD (main) ========== */
        const keypadLayout = ['7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', '0', '.', '(', ')', 'C', '⌫', '=', '+'];
        const keypadEl = document.getElementById('keypad');
        keypadLayout.forEach(k => {
            const el = document.createElement('div'); el.className = 'key' + (['/', '*', '-', '+', '=', 'C', '⌫'].includes(k) ? ' op' : ''); el.textContent = k;
            function handler(e) { 
                e.preventDefault && e.preventDefault(); 
                const inp = document.getElementById('calcInput'); 
                if (k === 'C') { inp.value = ''; document.getElementById('calcResult').textContent = '—'; return; } 
                if (k === '⌫') { inp.value = inp.value.slice(0, -1); return; } 
                if (k === '=') { evaluateMain(); return; } 
                inp.value += k; 
                inp.focus();
            }
            el.addEventListener('mousedown', handler); 
            el.addEventListener('touchstart', handler, { passive: false }); 
            keypadEl.appendChild(el);
        });

        /* ========== NATURAL LANGUAGE PARSING (improved) ========== */
        function wordsToMath(str) {
            if (!str) return '';
            let s = ' ' + String(str).toLowerCase().trim() + ' ';
            s = s.replace(/×/g, ' * ').replace(/÷/g, ' / ').replace(/—/g, ' - ');
            s = s.replace(/\bminus\b/g, ' - ').replace(/\bsubtract\b/g, ' - ').replace(/\bplus\b/g, ' + ').replace(/\badd\b/g, ' + ');
            s = s.replace(/\b(square root of|sqrt of|sqrt|root of)\b/g, ' sqrt ');
            s = s.replace(/\b(cube root of|cbrt|cube root)\b/g, ' cbrt ');
            s = s.replace(/\b(square of|square)\b/g, ' (x^2) ');
            s = s.replace(/\b(cube of|cube)\b/g, ' (x^3) ');
            const small = { zero: 0, one: 1, two: 2, three: 3, four: 4, five: 5, six: 6, seven: 7, eight: 8, nine: 9, ten: 10, eleven: 11, twelve: 12, thirteen: 13, fourteen: 14, fifteen: 15, sixteen: 16, seventeen: 17, eighteen: 18, nineteen: 19 };
            const tens = { twenty: 20, thirty: 30, forty: 40, fifty: 50, sixty: 60, seventy: 70, eighty: 80, ninety: 90 };
            Object.keys(tens).forEach(key => { s = s.replace(new RegExp(`\\b${key}\\s+(?:` + Object.keys(small).join('|') + `)\\b`, 'g'), (m) => { const parts = m.split(' '); return String(tens[parts[0]] + (small[parts[1]] || 0)); }); });
            Object.keys(small).forEach(k => s = s.replace(new RegExp('\\b' + k + '\\b', 'g'), String(small[k])));
            s = s.replace(/\b(\d+)\s+hundred\b/g, (_, n) => String(Number(n) * 100));
            s = s.replace(/\b(\d+)\s+thousand\b/g, (_, n) => String(Number(n) * 1000));
            s = s.replace(/\b(into|multiply|multiplied by|times)\b/g, ' * ');
            s = s.replace(/\b(divide|divided by|over|by)\b/g, ' / ');
            s = s.replace(/\b(power of|to the power of|to the power)\b/g, ' ^ ');
            s = s.replace(/\s+/g, ' ').trim();
            return s;
        }

        /* ========== EVALUATE MAIN ========== */
        function evaluateMain() {
            const raw = document.getElementById('calcInput').value.trim();
            if (!raw) return;
            let expr = raw;
            if (/[a-z]/i.test(raw)) expr = wordsToMath(raw);
            expr = expr.replace(/\(x\^2\)\s*([0-9.]+)?/g, (m, n) => n ? `(${n}^2)` : m);
            expr = expr.replace(/\(x\^3\)\s*([0-9.]+)?/g, (m, n) => n ? `(${n}^3)` : m);
            expr = expr.replace(/\bsqrt\s+([0-9.()]+)/g, 'sqrt($1)');
            expr = expr.replace(/\bcbrt\s+([0-9.()]+)/g, 'cbrt($1)');
            try {
                const v = math.evaluate(expr);
                const res = (typeof v === 'number' && !Number.isFinite(v)) ? 'NaN' : String(v);
                document.getElementById('calcResult').textContent = res;
                pushHistory(raw, res);
            } catch (e) { document.getElementById('calcResult').textContent = 'Error'; }
        }
        document.getElementById('calcInput').addEventListener('keydown', e => { if (e.key === 'Enter') evaluateMain(); });

        /* ========== GRAPH (fixed) ========== */
        let chartInstance = null;
        document.getElementById('plotBtn').addEventListener('click', () => {
            const f = document.getElementById('fn').value || 'sin(x)';
            const xmin = Number(document.getElementById('xmin').value || -10);
            const xmax = Number(document.getElementById('xmax').value || 10);
            const N = 500; // Reduced for mobile performance
            const xs = Array.from({ length: N }, (_, i) => xmin + (i * (xmax - xmin)) / (N - 1));
            let ys = [];
            try {
                const compiled = math.parse(f).compile();
                ys = xs.map(x => { try { const y = compiled.evaluate({ x }); return (typeof y === 'number' ? y : NaN); } catch { return NaN; } });
            } catch (e) { alert('Invalid function'); return; }
            const canvas = document.getElementById('chartCanvas');
            canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
            const ctx = canvas.getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'f(x)', data: xs.map((x, i) => ({ x: x, y: ys[i] })), borderColor: '#7be3ff', borderWidth: 2, pointRadius: 0 }] },
                options: {
                    animation: { duration: 300 }, // Faster animation for mobile
                    parsing: false, normalized: true,
                    scales: { x: { type: 'linear', title: { display: true, text: 'x' } }, y: { title: { display: true, text: 'y' } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `y=${ctx.parsed.y.toFixed(2)}` } } },
                    responsive: true, maintainAspectRatio: false
                }
            });
            setTimeout(() => chartInstance.resize(), 100);
        });

        /* ========== PROGRAMMER BASES & BITWISE ========== */
        function syncBasesFrom(value, type) { 
            let n; 
            try { 
                if (type === 'dec') n = parseInt(value, 10); 
                if (type === 'hex') n = parseInt(value.replace(/^0x/i, ''), 16); 
                if (type === 'bin') n = parseInt(value.replace(/^0b/i, ''), 2); 
            } catch (e) { } 
            if (Number.isNaN(n)) return; 
            document.getElementById('dec').value = n; 
            document.getElementById('hex').value = '0x' + (n >>> 0).toString(16).toUpperCase(); 
            document.getElementById('bin').value = '0b' + (n >>> 0).toString(2); 
        }
        document.getElementById('dec').addEventListener('input', e => syncBasesFrom(e.target.value, 'dec'));
        document.getElementById('hex').addEventListener('input', e => syncBasesFrom(e.target.value, 'hex'));
        document.getElementById('bin').addEventListener('input', e => syncBasesFrom(e.target.value, 'bin'));
        syncBasesFrom('42', 'dec');
        document.getElementById('computeBits').addEventListener('click', () => {
            const A = Number(document.getElementById('aInt').value || 0), B = Number(document.getElementById('bInt').value || 0);
            const op = document.getElementById('bitOp').value; let r;
            try { 
                switch (op) { 
                    case '&': r = A & B; break; 
                    case '|': r = A | B; break; 
                    case '^': r = A ^ B; break; 
                    case '<<': r = A << B; break; 
                    case '>>': r = A >> B; break; 
                    default: r = ~A; 
                } 
                document.getElementById('bitOut').textContent = `A=${A} (${(A >>> 0).toString(2)})\nB=${B} (${(B >>> 0).toString(2)})\nop=${op}\n= ${r} (bin ${(r >>> 0).toString(2)})`;
                pushHistory(`bit:${A}${op}${B}`, r); 
            } catch (e) { document.getElementById('bitOut').textContent = 'Error'; }
        });

        /* ========== UNIT CONVERTER ========== */
        const unitCatalog = {
            length: { m: 1, km: 1000, cm: 0.01, mm: 0.001, mi: 1609.344, ft: 0.3048, in: 0.0254 },
            mass: { kg: 1, g: 0.001, lb: 0.45359237, oz: 0.028349523125 },
            time: { s: 1, min: 60, hr: 3600 },
            temp: { C: 'C', F: 'F', K: 'K' },
            volume: { L: 1, mL: 0.001, 'm^3': 1000, gal: 3.78541 },
            speed: { 'm/s': 1, 'km/h': 0.277777778, 'mph': 0.44704 },
            energy: { J: 1, kJ: 1000, cal: 4.184 }
        };
        const catSel = document.getElementById('cat'), fromUnit = document.getElementById('fromUnit'), toUnit = document.getElementById('toUnit');
        function loadUnits() { 
            const cat = catSel.value; 
            fromUnit.innerHTML = ''; toUnit.innerHTML = ''; 
            Object.keys(unitCatalog[cat]).forEach(u => { fromUnit.add(new Option(u, u)); toUnit.add(new Option(u, u)); }); 
        }
        catSel.addEventListener('change', loadUnits); loadUnits();
        function convertTemp(v, from, to) { 
            let K; 
            if (from === 'C') K = v + 273.15; 
            else if (from === 'F') K = (v - 32) * 5 / 9 + 273.15; 
            else K = v; 
            if (to === 'C') return K - 273.15; 
            if (to === 'F') return (K - 273.15) * 9 / 5 + 32; 
            return K; 
        }
        document.getElementById('doConvert').addEventListener('click', () => { 
            const cat = catSel.value; 
            const v = Number(document.getElementById('uVal').value); 
            const from = fromUnit.value; 
            const to = toUnit.value; 
            if (!Number.isFinite(v)) { document.getElementById('uOut').textContent = 'Enter a number'; return; } 
            let out; 
            if (cat === 'temp') out = convertTemp(v, from, to); 
            else out = v * unitCatalog[cat][from] / unitCatalog[cat][to]; 
            document.getElementById('uOut').textContent = `${v} ${from} = ${out.toFixed(4)} ${to}`; 
            pushHistory(`${v}${from}->${to}`, out); 
        });

        /* ========== MATRIX (robust) ========== */
        function buildMatrixInputs(rows, cols, containerId) {
            const container = document.getElementById(containerId); container.innerHTML = ''; 
            container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`; container.classList.add('matrixGrid');
            for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) {
                const inp = document.createElement('input'); inp.type = 'number'; inp.step = 'any'; inp.placeholder = `${r + 1},${c + 1}`; inp.dataset.pos = `${r},${c}`;
                inp.addEventListener('keydown', (ev) => {
                    const key = ev.key;
                    const [rr, cc] = inp.dataset.pos.split(',').map(Number);
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(key)) {
                        ev.preventDefault();
                        let nr = rr, nc = cc;
                        if (key === 'ArrowUp') nr = Math.max(0, rr - 1);
                        if (key === 'ArrowDown') nr = rr + 1;
                        if (key === 'ArrowLeft') nc = Math.max(0, cc - 1);
                        if (key === 'ArrowRight' || key === 'Tab') nc = cc + 1;
                        const parent = inp.parentElement;
                        const idx = nr * parseInt(parent.style.gridTemplateColumns.split(' ').length || '1') + nc;
                        const next = parent.querySelectorAll('input')[idx];
                        if (next) next.focus();
                        return;
                    }
                }, { passive: false });
                container.appendChild(inp);
            }
        }
        function readMatrix(containerId, rows, cols) {
            const container = document.getElementById(containerId); const inputs = Array.from(container.querySelectorAll('input'));
            const M = [];
            for (let r = 0; r < rows; r++) {
                const row = [];
                for (let c = 0; c < cols; c++) {
                    const idx = r * cols + c;
                    const val = Number(inputs[idx]?.value || 0);
                    row.push(val);
                }
                M.push(row);
            }
            return M;
        }
        document.getElementById('buildMatrices').addEventListener('click', () => {
            const rA = Math.max(1, Math.min(8, Number(document.getElementById('rowsA').value || 2)));
            const cA = Math.max(1, Math.min(8, Number(document.getElementById('colsA').value || 2)));
            const rB = Math.max(1, Math.min(8, Number(document.getElementById('rowsB').value || 2)));
            const cB = Math.max(1, Math.min(8, Number(document.getElementById('colsB').value || 2)));
            buildMatrixInputs(rA, cA, 'matA'); buildMatrixInputs(rB, cB, 'matB');
        });
        document.getElementById('doMatrix').addEventListener('click', () => {
            const rA = Math.max(1, Math.min(8, Number(document.getElementById('rowsA').value || 2)));
            const cA = Math.max(1, Math.min(8, Number(document.getElementById('colsA').value || 2)));
            const rB = Math.max(1, Math.min(8, Number(document.getElementById('rowsB').value || 2)));
            const cB = Math.max(1, Math.min(8, Number(document.getElementById('colsB').value || 2)));
            const op = document.getElementById('mOp').value;
            try {
                const A = readMatrix('matA', rA, cA);
                let out;
                if (op === 'add' || op === 'sub') {
                    if (rA !== rB || cA !== cB) throw new Error('A and B must have same dimensions for add/sub.');
                    const B = readMatrix('matB', rB, cB); out = (op === 'add') ? math.add(A, B) : math.subtract(A, B);
                } else if (op === 'mul') {
                    if (cA !== rB) throw new Error('A.cols must equal B.rows for multiplication.');
                    const B = readMatrix('matB', rB, cB); out = math.multiply(A, B);
                } else if (op === 'div') {
                    if (rB !== cB) throw new Error('B must be square and invertible for division.');
                    const B = readMatrix('matB', rB, cB); out = math.multiply(A, math.inv(B));
                } else if (op === 'det') {
                    if (rA !== cA) throw new Error('A must be square for determinant.');
                    out = math.det(A);
                } else if (op === 'inv') {
                    if (rA !== cA) throw new Error('A must be square for inverse.');
                    out = math.inv(A);
                } else if (op === 'transA') { out = math.transpose(A); }
                else if (op === 'transB') { const B = readMatrix('matB', rB, cB); out = math.transpose(B); }
                document.getElementById('mOut').textContent = Array.isArray(out) ? out.map(row => row.join('\t')).join('\n') : String(out);
                pushHistory(`matrix:${op}`, JSON.stringify(out));
            } catch (e) { document.getElementById('mOut').textContent = 'Error: ' + e.message; }
        });

        /* ========== IMAGE OCR ========== */
        document.getElementById('imgInput').addEventListener('change', async (e) => {
                const f = e.target.files[0];
                if (!f) return;
                document.getElementById('ocrStatus').textContent = 'Reading…';
                document.getElementById('ocrSteps').textContent = '—';
                try {
                    // Image Pre-processing
                    const preprocessedImage = await preprocessImage(f);

                    const worker = await Tesseract.createWorker({
                        logger: m => {
                            document.getElementById('ocrStatus').textContent = `${m.status} ${Math.round((m.progress || 0) * 100)}%`;
                        }
                    });

                    await worker.loadLanguage('eng');
                    await worker.initialize('eng');
                    const { data: { text } } = await worker.recognize(preprocessedImage);
                    await worker.terminate();

                    const expr = text.replace(/\s+/g, '').trim();
                    console.log("Recognized Text (raw):", text);
                    console.log("Recognized Text (processed):", expr);

                    // More flexible linear equation regex: Handles optional spaces and +/- signs better.
                    const linearMatch = expr.match(/^([\-]?\d*\.?\d*)x([+\-]?\d*\.?\d*)\=([\-]?\d*\.?\d*)$/i);

                    // Quadratic equation regex: Handles optional spaces and +/- signs.
                    const quadraticMatch = expr.match(/^([\-]?\d*\.?\d*)x\^2([+\-]?\d*\.?\d*)x([+\-]?\d*\.?\d*)\=0$/i);

                    if (linearMatch) {
                        const a = parseFloat(linearMatch[1] || '1');
                        const b = parseFloat(linearMatch[2] || '0');
                        const c = parseFloat(linearMatch[3] || '0');

                        const s1 = `${a}x ${b < 0 ? '-' : '+'} ${Math.abs(b)} = ${c}`;
                        const s2 = `${a}x = ${c} ${b < 0 ? '+' : '-'} ${Math.abs(b)} \u21D2 ${a}x = ${c - b}`;
                        const s3 = `x = ${(c - b)} / ${a} \u21D2 x = ${(c - b) / a}`;
                        document.getElementById('ocrSteps').textContent = `Expression: ${text}\n\nSteps:\n1) ${s1}\n2) ${s2}\n3) ${s3}`;
                    } else if (quadraticMatch) {
                        const a = parseFloat(quadraticMatch[1] || '1');
                        const b = parseFloat(quadraticMatch[2] || '0');
                        const c = parseFloat(quadraticMatch[3] || '0');
                        const discriminant = b * b - 4 * a * c;

                        if (discriminant >= 0) {
                            const x1 = (-b + Math.sqrt(discriminant)) / (2 * a);
                            const x2 = (-b - Math.sqrt(discriminant)) / (2 * a);
                            document.getElementById('ocrSteps').textContent = `Expression: ${text}\nRoots:\nx1 = ${x1}\nx2 = ${x2}`;
                        } else {
                            document.getElementById('ocrSteps').textContent = `Expression: ${text}\nResult: Complex roots. Discriminant is negative.`;
                        }
                    } else {
                        try {
                            const res = math.evaluate(expr);
                            document.getElementById('ocrSteps').textContent = `Expression: ${text}\nResult: ${res}`;
                        } catch (e) {
                            document.getElementById('ocrSteps').textContent = 'No readable linear, quadratic, or arithmetic expression.';
                            console.log("Math.js evaluation failed:", e);
                        }
                    }
                    document.getElementById('ocrStatus').textContent = 'Done ✅';
                } catch (e) {
                    document.getElementById('ocrStatus').textContent = 'OCR failed ❌';
                    document.getElementById('ocrSteps').textContent = 'An error occurred. Please try a clearer image.';
                    console.error("An error occurred:", e);
                }
            });

            // Pre-processing function to scale and grayscale the image
            async function preprocessImage(file) {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = new Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Scale up the image by a factor of 2 for better OCR
                            const scaleFactor = 2;
                            canvas.width = img.width * scaleFactor;
                            canvas.height = img.height * scaleFactor;

                            // Draw the scaled image and convert it to grayscale
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = data[i + 1] = data[i + 2] = avg;
                            }
                            ctx.putImageData(imageData, 0, 0);

                            canvas.toBlob(blob => {
                                resolve(blob);
                            });
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }


        /* ========== EXPORT TXT/PDF ========== */
        function downloadTxt() { 
            const sec = document.querySelector('.section:not([style*="display:none"])') || document.body; 
            const text = sec.innerText || document.body.innerText; 
            const blob = new Blob([text], { type: 'text/plain' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'Megacalculator_Pro.txt'; 
            a.click(); 
            a.remove(); 
        }
        async function downloadPdf() { 
            const { jsPDF } = window.jspdf || {}; 
            if (!jsPDF) { alert('jsPDF missing'); return; } 
            const doc = new jsPDF(); 
            const sec = document.querySelector('.section:not([style*="display:none"])') || document.body; 
            let y = 20; 
            doc.setFontSize(14); 
            doc.text('Megacalculator Pro', 12, y); 
            y += 8; 
            doc.setFontSize(10); 
            const lines = doc.splitTextToSize(sec.innerText || '', 180); 
            lines.forEach(line => { y += 6; if (y > 270) { doc.addPage(); y = 20 } doc.text(line, 12, y); }); 
            doc.save('Megacalculator_Pro.pdf'); 
        }
        document.getElementById('exportTxt').addEventListener('click', downloadTxt);
        document.getElementById('exportPdf').addEventListener('click', downloadPdf);

        /* ========== MINI VOICE ========== */
        const miniBtn = document.getElementById('miniBtn'), miniToast = document.getElementById('miniToast');
            let miniRec;
            (function setupMiniVoice() {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) { miniBtn.title = 'Voice not supported'; return; }
                miniRec = new SR(); miniRec.lang = 'en-IN'; miniRec.interimResults = false; miniRec.maxAlternatives = 1;
                miniRec.onresult = (ev) => {
                    const said = ev.results[0][0].transcript;
                    handleMiniSpeech(said);
                };
                miniRec.onend = () => { /* stop */ };
            })();
            miniBtn.addEventListener('click', () => {
                if (!miniRec) { alert('Voice not supported'); return; }
                miniToast.style.display = 'block'; miniToast.textContent = 'Listening…';
                miniRec.start();
            });
            function handleMiniSpeech(said) {
                // parse same as main; improved edge cases
                let expr = said;
                if (/[a-z]/i.test(said)) expr = wordsToMath(said);
                expr = expr.replace(/\(x\^2\)\s*([0-9.]+)?/g, (m, n) => n ? `(${n}^2)` : m);
                expr = expr.replace(/\(x\^3\)\s*([0-9.]+)?/g, (m, n) => n ? `(${n}^3)` : m);
                expr = expr.replace(/\bsqrt\s+([0-9.()]+)/g, 'sqrt($1)');
                expr = expr.replace(/\bcbrt\s+([0-9.()]+)/g, 'cbrt($1)');
                try {
                    const res = math.evaluate(expr);
                    const text = `${said} = ${res}`;
                    miniToast.textContent = text;
                    setTimeout(() => miniToast.style.display = 'none', 5200);
                    pushHistory(said, res);
                    speak(String(res));
                } catch (e) {
                    miniToast.textContent = 'Could not compute';
                    setTimeout(() => miniToast.style.display = 'none', 3000);
                    speak('Could not compute');
                }
            }

        /* ========== SPEAK UTILITY ========== */
        function speak(txt) { 
            try { 
                const u = new SpeechSynthesisUtterance(String(txt)); 
                u.rate = 1; 
                speechSynthesis.cancel(); 
                speechSynthesis.speak(u); 
            } catch (e) { } 
        }

        /* ========== KEYBOARD SHORTCUTS & UI HELPERS ========== */
        document.addEventListener('keydown', e => { 
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') { 
                document.getElementById('calcInput').focus(); 
                e.preventDefault(); 
            } 
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'g') { 
                activateSection('graph'); 
                e.preventDefault(); 
            } 
        });

        /* ========== SEARCH + UNDO UI ========== */
        document.getElementById('searchHistory').addEventListener('input', (e) => renderHistory(e.target.value));
        document.getElementById('undoBtn').addEventListener('click', () => { undoHistory(); });

        /* ========== INITIAL UI state ========== */
        buildMatrixInputs(2, 2, 'matA'); buildMatrixInputs(2, 2, 'matB'); renderHistory();

        /* ========== PWA SETUP ========== */
         (function pwaSetup() {
            // prepare manifest (inline blob)
            try {
                const manifest = { name: "Megacalculator Pro", short_name: "Megacalc", start_url: ".", display: "standalone", background_color: "#07101a", theme_color: "#07101a", icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='100%25' height='100%25' rx='24' fill='%2307111a'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' font-size='72' fill='%23fff' font-family='Arial' dy='.25em'%3E%F0%9F%92%8C%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }] };
                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
                const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
            } catch (e) { console.warn('manifest create failed', e); }

            // install prompt handling
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                STATE.deferredPrompt = e;
                const installBtn = document.getElementById('installBtn'); installBtn.style.display = 'inline-block';
                installBtn.addEventListener('click', async () => {
                    installBtn.style.display = 'none';
                    if (STATE.deferredPrompt) { STATE.deferredPrompt.prompt(); const choice = await STATE.deferredPrompt.userChoice; STATE.deferredPrompt = null; }
                }, { once: true, passive: true });
            });

            // service worker with better cache & update detection
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE = 'megacalculator-pro-v2';
                    const ASSETS = [
                        '.', 
                        'https://cdn.jsdelivr.net/npm/mathjs@11/lib/browser/math.js',
                        'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
                        'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js',
                        'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'
                    ];
                    self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=> c.addAll(ASSETS)).catch(()=>{})); self.skipWaiting(); });
                    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
                    self.addEventListener('fetch', e=> {
                        if(e.request.method !== 'GET') return;
                        e.respondWith(caches.match(e.request).then(resp => resp || fetch(e.request).then(fetchResp => { return caches.open(CACHE).then(c=>{ c.put(e.request, fetchResp.clone()); return fetchResp; }); }).catch(()=> caches.match('.'))));
                    });
                    self.addEventListener('message', event => {
                        if(event.data && event.data.type === 'SKIP_WAITING'){ self.skipWaiting(); }
                    });
                    `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swURL).then(reg => {
                    // listen for updates
                    reg.addEventListener('updatefound', () => {
                        const newSW = reg.installing;
                        newSW.addEventListener('statechange', () => {
                            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                                // notify user
                                STATE.swUpdateAvailable = true;
                                showUpdateAvailable();
                            }
                        });
                    });
                }).catch(() => {/* ignore sw failure */ });
            }

            // show update UI
            function showUpdateAvailable() {
                const installBtn = document.getElementById('installBtn');
                const up = document.createElement('button'); up.textContent = 'Update'; up.className = 'btn';
                up.style.marginLeft = '8px';
                up.addEventListener('click', () => { if (navigator.serviceWorker.controller) { navigator.serviceWorker.getRegistration().then(reg => { reg && reg.waiting && reg.waiting.postMessage({ type: 'SKIP_WAITING' }); window.location.reload(); }); } });
                installBtn.insertAdjacentElement('afterend', up);
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
                // Add styling class to every select on the page
                document.querySelectorAll('select').forEach(s => s.classList.add('mcSelect'));
            });

            let deferredPrompt;

                window.addEventListener("beforeinstallprompt", e => {
                    e.preventDefault();
                    deferredPrompt = e; // save event for later
                });

                // Example: trigger when user clicks "Install App" button
                document.getElementById("installBtn").addEventListener("click", () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(choice => {
                            console.log("User choice:", choice.outcome);
                            deferredPrompt = null;
                        });
                    }
                });


    </script>
</body>

</html>
            
          
